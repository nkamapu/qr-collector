<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Collector — Secure POST</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{font-family:system-ui;margin:16px;}
    button{padding:8px 12px;margin:4px;}
    #log{white-space:pre-wrap;border:1px solid #ddd;padding:8px;min-height:100px;}
  </style>
</head>
<body>
  <h1>QR Collector</h1>
  <p>iPhoneのSafariで開き、カメラ許可→QR連続読み取り→CSV/TXT保存 または Google Apps Scriptへ安全に送信。</p>

  <button id="start">スキャン開始</button>
  <button id="stop" disabled>停止</button>
  <button id="send">Apps Scriptへ送信</button>

  <p>件数: <span id="count">0</span></p>
  <div id="log"></div>

  <script>
    // === 状態 ===
    let html5QrCode=null;
    let items=[];
    const secret = 'hogehoge2025';  // Apps Script と一致させる
    const postUrl = 'https://script.google.com/macros/s/AKfycbz6J5K9Wsj2sZb3Y1Xj48nvnsMmH2h2VzNXF5rgeucr5wWD7w3RG0EEEinbT0hsHlLI/exec'; // あなたのURL

    function updateLog(){
      document.getElementById('count').textContent = items.length;
      document.getElementById('log').textContent = items.join('\n');
    }

    async function startScan(){
      const cameras = await Html5Qrcode.getCameras();
      const cam = cameras.find(c=>/back|rear|environment/i.test(c.label))||cameras[0];
      html5QrCode = new Html5Qrcode('reader');
      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
      html5QrCode.start(cam.id,{fps:15,qrbox:250},(decoded)=>{
        if(!items.includes(decoded)){
          items.push(decoded);
          updateLog();
        }
      });
    }

    async function stopScan(){
      if(html5QrCode){await html5QrCode.stop();await html5QrCode.clear();}
      document.getElementById('start').disabled=false;
      document.getElementById('stop').disabled=true;
    }

    async function sendData(){
      if(!items.length){alert('データがありません');return;}
      const body = items.join('\n');
      try{
        const res = await fetch(postUrl,{
          method:'POST',
          headers:{'Content-Type':'text/plain','X-QR-Token':secret},
          body
        });
        alert('送信完了: '+res.status);
      }catch(e){alert('送信失敗: '+e);}
    }

    // ボタン結合
    document.getElementById('start').onclick=startScan;
    document.getElementById('stop').onclick=stopScan;
    document.getElementById('send').onclick=sendData;
  </script>
  <div id="reader" style="width:300px;margin-top:12px;"></div>
</body>
</html>
